name: Set Priority Label

on:
  issues:
    types: [opened]

jobs:
  set-label:
    runs-on: ubuntu-latest
    steps:
      - name: Get Project Details
        id: get_project
        run: |
          PROJECT_ID=1

          curl -L \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: token ${{ secrets.MY_PAT }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/projects/${PROJECT_ID} \
            | jq -r '.id'

      - name: Get Project Columns
        id: get_columns
        run: |
          PROJECT_ID=${{ steps.get_project.outputs.result }}
          
          curl -X GET \
            -H "Authorization: token ${{ secrets.MY_PAT }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/projects/${PROJECT_ID}/columns \
            | jq -c '.[] | {id: .id, name: .name}' > columns.json

      - name: Set Priority Label
        id: set_label
        run: |
          LABEL=""
          
          while IFS= read -r line; do
            COLUMN_NAME=$(echo $line | jq -r '.name')
            if [[ "$COLUMN_NAME" == "DistantFeature" ]]; then
              LABEL="Priority: Low"
            elif [[ "$COLUMN_NAME" == "Todo" ]]; then
              LABEL="Priority: Medium"
            fi
          done < columns.json

          if [ -n "$LABEL" ]; then
            curl -X POST \
              -H "Authorization: token ${{ secrets.MY_PAT }}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/labels \
              -d "[\"$LABEL\"]"
          else
            echo "No matching column found for setting label."
          fi
